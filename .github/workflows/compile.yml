env:
    EM_VERSION: 2.0.1
    EM_CACHE_FOLDER: "emsdk-cache"

name: Compile and test
on: [push, pull_request]
jobs:
    build:
        name: Check if benchmarks work
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Setup cache
              id: cache-system-libraries
              uses: actions/cache@v2
              with:
                  path: ${{env.EM_CACHE_FOLDER}}
                  key: ${{env.EM_VERSION}}-${{ runner.os }}
            - name: Setup emsdk
              uses: mymindstorm/setup-emsdk@v7
              with:
                  version: ${{env.EM_VERSION}}
                  actions-cache-folder: ${{env.EM_CACHE_FOLDER}}
            - name: Verify
              run: emcc -v
            - name: Build benchmarks
              run: make -C benchmarks/ clean all
            - name: Run benchmarks
              run: cd benchmarks/ && ./bin/warduino_benchmark
    formatting-check:
        name: Formatting Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Run clang-format style check for C/C++ programs.
              uses: jidicula/clang-format-action@v3.2.0
              with:
                  clang-format-version: "11"
                  check-path: "."
                  fallback-style: "Google"
