name: Tests
on: [ push, pull_request ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # Cancel in-flight jobs for the same branch or PR

jobs:
  unit:
    name: Run VM unit tests
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Create build folder
        run: mkdir build-unit-tests

      - name: Build unit tests
        run: cmake .. -D BUILD_UNITTEST=ON ; cmake --build .
        working-directory: build-unit-tests

      - name: Run unit tests
        run: ctest -VV
        working-directory: build-unit-tests

